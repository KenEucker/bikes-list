<html>
  <head>
    <title>Updating the dates</title>
  </head>
  <body>
    <h1>Updating the dates</h1>
    This document describes how dates are updated when you hit [Submit] on
    the event submission/editing form.

    <h2>In the form</h2>
    When you enter a date description in the form, the date string is
    immediately sent to the host which parses it, builds a list of actual
    dates, and merges information about existing <code>caldaily</code> records.
    This information is then sent back to the form, where it is displayed
    in the page near the date string.
    This is implemented via the "<code>vfydates.php?dates=...</code>" request.
    <p>
    This way, the user can see exactly what dates will be added, which
    will be canceled or moved, and which will be left unchanged.
    <p>
    The form will do more than just list the dates.
    The user can change the status of each date.
    For new dates (i.e., dates that didn't match the previous "dates" string
    and hence have no records in the <code>caldaily</code> table),
    the possible statuses are <code>Add</code> and <code>Skip</code>.
    <code>Add</code> means it'll be added as "As Scheduled" when you submit
    the form.
    <code>Skip</code> means it'll be added as "Skipped" when you submit
    the form.
    <p>
    For existing dates, the possible statuses are <code>As Scheduled</code>,
    <code>Canceled</code>, <code>Deleted</code>, and <code>Exception</code>.
    <code>Canceled</code> means the <code>caldaily</code> record will still
    exist, but it'll be skipped in the calendar listing.
    <code>Deleted</code> is only offered for dates more than two months in
    the future, which don't match the current "dates" string; if causes the
    <code>caldaily</code> record to be deleted.
    The <code>Exception</code> status means the normal event was canceled
    for that day, but a related event was created to replace it; the
    <code>caldaily</code> record will contain the event id for that event,
    and the form should display a link for editing that event.
    If the <code>Exception</code> event is ever canceled, the corresponding
    record should be rewritten with status=Canceled.
    <p>
    The <code>Exception</code> status is odd.
    If the user changes a date to be <code>Exception</code>, then the form
    should immediately create a new event which is a duplicate of the
    existing event, except that its dates consist only of the exceptional date.
    Then it should make the user edit that event instead of the current one.
    (It should ask for confirmation before doing this, naturally.)
    <p>
    Note: I considered adding "Moved From" and "Moved To" statuses, to make
    it easy to move a repeating event from its usual day to some other day.
    However, the code needed to support this gets rather intricate, and I
    expect it to be rare.
    Also, the <code>Exception</code> status can be used to handle this,
    albeit in a slightly less obvious way.
    <p>
    Also, the form can then prompt for "newsflash" strings for existing
    dates (which is particularly important for dates that have been, or
    soon will be, canceled or moved).
    One exception is that if the date is to be <code>Deleted</code> then
    there's no place to store a newsflash so it should not prompt for a
    newsflash.
    <p>
    This portion of the form is dynamically generated.
    Consequently, it's fairly easy to incorporate the date into the
    parameter names; no special step is needed to pack all of these
    date-specific values into a single parameter.

    <h2>When submitted</h2>
    When the user hits the form's [Submit] button, the data is sent to the
    host as a "<code>calsubmit.php</code>" request with <em>zillions</em>
    of parameters.
    <p>
    Among other things, the request will parse the "dates" string and
    merge it with any existing <code>caldaily</code> records.
    This is exactly like the <code>vfydates.php</code> request that was
    performed before the request was submitted, so it should generate
    exactly the same list.
    <p>
    By scanning this list of actual dates, it can divine which parameter
    names to check for date-specific parameters.
    The parameter will guide the changes needed, if any.

    <h2>In calendar views</h2>
    All calendar views are generated by scanning the <code>caldaily</code>
    table.
    All views will want to skip records with status <code>Skipped</code>.
    Most will want to skip <code>Exception</code>, since the exceptional version
    of that event is represented by a different <code>caldaily</code> record,
    possibly on the same day.
    Some views will want to skip <code>Canceled</code> record, but other will
    want to display them with the time shown as "CANCELED", or with a strikeout
    line drawn through the entire text of the event, or something like that.
    <p>
    If the <code>caldaily</code> record has a non-empty newflash field,
    then its tinytitle should be displayed in magenta.
    In the body where the full description is shown, the newsflash text should
    be appended, in magenta.  (The rest of the body should be normal.)

    <h2>Common code</h2>
    We store a single character in the file, not the whole status name.
    We'll need a way to convert them.
    Since there is no single-character status name, the two sets of
    strings are easy to distinguish, and we can use a single function
    to convert in both directions.
    This also leads us to see some overlap in "new date" statuses (which
    aren't actually stored in the <code>caldaily</code> file) and "existing
    date" status (which are).
    <pre>
	function statusname($dateinfo)
	{
		switch ($dateinfo[status]) {
		  case "Added":		return "A";
		  case "As Scheduled":	return "A";
		  case "A":		return "As Scheduled";
		  case "Skipped":	return "S";
		  case "S":		return "Skipped";
		  case "Canceled":	return "C";
		  case "C":		return "Canceled";
		  case "Deleted":	return "D";
		  case "D":		return "Deleted";
		  case "Exception":	return "E";
		  case "E":		return "Exception";
		}
	}
    </pre>	
    <p>
    The <code>mergedates()</code> code will shared.  It is needed by both
    vfydates.php and calsubmit.php.
    For each date, it will need to provide the following information:
    <ul>
    <li><code>timestamp</code>The timestamp, as used by date().
    <li><code>sqldate</code>The SQL date, for MySQL requests.
    <li><code>newdate</code>An indicator for whether the new "dates" string includes this date
    <li><code>olddate</code>An indicator for whether there's currently a record for this date
    <li><code>status</code>The status: Added, Skipped, As Scheduled, Canceled, Deleted, Exception.
    <li><code>exceptionid</code>If status is Exception, it should include the exceptional date's id.
    <li><code>changed</code>An indicator of whether this day will be changed (other than newsflash).
    </ul>
  </body>
</html>
